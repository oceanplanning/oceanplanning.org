<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Moore Foundation map prototype by Stamen Design</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src='vendor/leaflet.ajax.min.js'></script>
<script src='vendor/d3.v3.min.js'></script>
<script src='vendor/queue.v1.min.js'></script>
<script src='vendor/proj4-compressed.js'></script>
<script src='vendor/proj4leaflet.js'></script>
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map'></div>

<script>

var crs = new L.Proj.CRS(
    'EPSG:2163',  // Guessing
    //'EPSG:3408', 
    '+proj=laea +lat_0=40 +lon_0=-105 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs',
    {
        origin: [60112700,20037600], // I don't understand where these come from
        resolutions: [
            null, 
            78271.51696484375,
            39135.758482421875,
            19567.8792412109375,
            9783.93962060546875,
            4891.969810302734375,
            2445.9849051513671875,
            1222.99245257568359375,
            611.496226287841796875,
            305.7481131439208984375,
            152.87405657196044921875,
            76.437028285980224609375,
            38.2185141429901123046875,
            19.10925707149505615234375,
            9.554628535747528076171875,
            4.7773142678737640380859375,
            2.388657133934688201904296875,
            1.194328566968441009521484375
        ] // I just copied these from somewhere


    }
);

var mapboxTiles = L.tileLayer('https://{s}.tiles.mapbox.com/v3/stamen.moore/{z}/{x}/{y}.png', {
    attribution: ''
});

var map = L.map('map', { 
      crs: crs,
      continuousWorld: false,
      worldCopyJump: false
    })
    .addLayer(mapboxTiles)
    .setView([35, -105], 3);

queue()
  .defer(d3.csv, "csv/data.csv")
  .defer(d3.json, "geojson/ma_coastalzone.geojson")
  .defer(d3.json, "geojson/ri_coastalzone.geojson")
  .defer(d3.json, "geojson/bc_mapp_subregions.geojson")
  .defer(d3.json, "geojson/bc_wcvi.geojson")
//  .defer(d3.json, "geojson/bc_pncima.geojson")
  .defer(d3.json, "geojson/hi_humpback_sanctuary.geojson")
  .await(function(error,
    csvdata,
    ma_coastalzone_geojson,
    ri_coastalzone_geojson,
    bc_mapp_subregions_geojson,
    bc_wcvi_geojson,
//    bc_pncima_geojson,
    hi_humpback_sanctuary_geojson
  ) {

    var overlayMaps = {};

    function popUp(feature, layer) {
        var html = feature.properties.Location;
        layer.bindPopup(html);
    }

    var geojsonMarkerOptions = {
        radius: 8,
        fillColor: "steelblue",
        color: "steelblue",
        weight: 2,
        opacity: 0.8,
        fillOpacity: 0.3
    };

    csvdata.forEach(function(row) {
      if (row.Latitude && row.Longitude) {
        var layer = L.geoJson({
          "type": "Feature",
          "properties": row,
          "geometry": {
            "type": "Point",
            "coordinates": [row.Longitude, row.Latitude]
          }
        }, {
          pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, geojsonMarkerOptions);
          },
          onEachFeature: popUp
        });
        map.addLayer(layer);
        overlayMaps[row.Location] = layer;
      }
    });

    // TODO: do this less stupidly
    ma_coastalzone_geojson.features.forEach(function(feature){
      feature.properties = csvdata[3];
    });
    ri_coastalzone_geojson.features.forEach(function(feature){
      feature.properties = csvdata[10];
    });
    bc_mapp_subregions_geojson.features.forEach(function(feature){
      feature.properties = csvdata[22];
    });
    bc_wcvi_geojson.features.forEach(function(feature){
      feature.properties = csvdata[23];
    });
    hi_humpback_sanctuary_geojson.features.forEach(function(feature) {
      feature.properties = csvdata[19];
    });

    function geojsonStyle(feature) {
      return {
        color: '#f09',
        opacity: 0.8,
        fillColor: '#f09',
        fillOpacity: 0.3,
        weight:2
      };
    }

    var ma_layer = new L.GeoJSON(ma_coastalzone_geojson, {style:geojsonStyle, onEachFeature:popUp});
    map.addLayer(ma_layer);

    var ri_layer = new L.GeoJSON(ri_coastalzone_geojson, {style:geojsonStyle, onEachFeature:popUp});
    map.addLayer(ri_layer);

    var bc_mapp_layer = new L.GeoJSON(bc_mapp_subregions_geojson, {style:geojsonStyle, onEachFeature:popUp});
    map.addLayer(bc_mapp_layer);

    var bc_wcvi_layer = new L.GeoJSON(bc_wcvi_geojson, {style:geojsonStyle, onEachFeature:popUp});
    map.addLayer(bc_wcvi_layer);

    //var bc_pncima_layer = new L.GeoJSON(bc_pncima_geojson, {style:geojsonStyle, onEachFeature:popUp});
    //map.addLayer(bc_pncima_layer);

    var hi_layer = new L.GeoJSON(hi_humpback_sanctuary_geojson, {style:geojsonStyle, onEachFeature:popUp});
    map.addLayer(hi_layer);

    overlayMaps["Massachusetts"] = ma_layer;
    overlayMaps["Rhode Island"] = ri_layer;
    overlayMaps["BC MAPP"] = bc_mapp_layer;
    overlayMaps["BC WCVI"] = bc_wcvi_layer;
    //overlayMaps["BC PNCIMA"] = bc_pncima_layer;
    overlayMaps["Hawaii"] = hi_layer;

    var options = {
      collapsed: false
    };

    L.control.layers(null, overlayMaps, options).addTo(map);

});

</script>
</body>
</html>
