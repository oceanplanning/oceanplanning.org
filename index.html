<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Moore Foundation map prototype by Stamen Design</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src='vendor/leaflet.ajax.min.js'></script>
<script src='vendor/d3.v3.min.js'></script>
<script src='vendor/queue.v1.min.js'></script>
<script src='vendor/proj4-compressed.js'></script>
<script src='vendor/proj4leaflet.js'></script>
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map'></div>

<script>

var crs = new L.Proj.CRS(
    'EPSG:2163',  // Guessing
    //'EPSG:3408', 
    '+proj=laea +lat_0=40 +lon_0=-105 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs',
    {
        origin: [60112700,20037600], // I don't understand where these come from
        resolutions: [
            null, 
            78271.51696484375,
            39135.758482421875,
            19567.8792412109375,
            9783.93962060546875,
            4891.969810302734375,
            2445.9849051513671875,
            1222.99245257568359375,
            611.496226287841796875,
            305.7481131439208984375,
            152.87405657196044921875,
            76.437028285980224609375,
            38.2185141429901123046875,
            19.10925707149505615234375,
            9.554628535747528076171875,
            4.7773142678737640380859375,
            2.388657133934688201904296875,
            1.194328566968441009521484375
        ] // I just copied these from somewhere


    }
);

var mapboxTiles = L.tileLayer('https://{s}.tiles.mapbox.com/v3/stamen.moore/{z}/{x}/{y}.png', {
    attribution: ''
});

var map = L.map('map', { 
      crs: crs,
      continuousWorld: false,
      worldCopyJump: false
    })
    .addLayer(mapboxTiles)
    .setView([35, -105], 3);

// This is awkward! Eventually we should store these geojson links in the csv
var tasks = [
  {
    "file": "geojson/LOMA_Beaufort_Sea.geojson",
    "label": "Beaufort Sea",
    "csv_id": 1
  }, {
    "file": "geojson/LOMA_Eastern_Scotian_Shelf.geojson",
    "label": "Eastern Scotian Shelf",
    "csv_id": 2
  }, {
    "file": "geojson/bc_mapp_north_coast.geojson",
    "label": "BC MaPP North Coast",
    "csv_id": 3
  }, {
    "file": "geojson/LOMA_Pacific_North_Coast.geojson",
    "label": "Pacific North Coast",
    "file2": "geojson/bc_pncima.geojson",
    "label2": "BC PNCIMA",
    "csv_id": 4
  }, {
    "file": "geojson/bc_wcvi.geojson",
    "label": "BC WCVI",
    "csv_id": 5
  }, {
    "file": "geojson/LOMA_Placentia_Bay___Grand_Banks.geojson",
    "label": "Placentia Bay / Grand Banks",
    "csv_id": 6
  }, {
    "file": "geojson/NLUP_Boundary.geojson",
    "label": "Nunavut",
    "csv_id": 7
  }, {
    "file": "geojson/great_lakes.geojson",
    "label": "Great Lakes",
    "csv_id": 8
  }, {
    "file": "geojson/pacific_islands.geojson",
    "label": "Pacific Islands",
    "csv_id": 12
  }, {
    "file": "geojson/south_atlantic.geojson",
    "label": "South Atlantic US",
    "csv_id": 13
  }, {
    "file": "geojson/us_caribbean.geojson",
    "label": "US Caribbean",
    "csv_id": 14
  }, {
    "file": "geojson/us_west_coast.geojson",
    "label": "US West Coast",
    "csv_id": 15
  }, {
    "file": "geojson/florida_keys.geojson",
    "label": "Florida Keys",
    "csv_id": 18
  }, {
    "file": "geojson/ma_coastalzone.geojson",
    "label": "Massachusetts",
    "csv_id": 22
  }, {
    "file": "geojson/oregon.geojson",
    "label": "Oregon",
    "csv_id": 24
  }, {
    "file": "geojson/ri_coastalzone.geojson",
    "label": "Rhode Island",
    "csv_id": 25
  }, {
    "file": "geojson/washington_state.geojson",
    "label": "Washington State",
    "csv_id": 31
  }, {
    "file": "geojson/hi_humpback_sanctuary.geojson",
    "label": "Hawaii Humpback Whale National Marine Sanctuary",
    "csv_id": 32
  }, {
    "file": "geojson/bc_mapp_haida_gwaii.geojson",
    "label": "BC MaPP Haida Gwaii",
    "csv_id": 33
  }, {
    "file": "geojson/LOMA_Gulf_of_Saint_Lawrence.geojson",
    "label": "Gulf of Saint Lawrence",
    "csv_id": 39
  }, {
    "file": "geojson/bc_mapp_central_coast.geojson",
    "label": "BC MaPP Central Coast",
    "csv_id": 40
  }, {
    "file": "geojson/bc_mapp_north_vancouver_island.geojson",
    "label": "BC MaPP North Vancouver Island",
    "csv_id": 41
  }
];

d3.csv("csv/data.csv", function(csvdata) {
  var q = queue();
  tasks.forEach(function(t) { q.defer(d3.json, t.file); });
  q.awaitAll(function(error, results) {

    // Apply the geojson objects to the tasks array
    for(var i = 0; i < results.length; i++) {
      tasks[i].geojson = results[i];
    }

    var overlayMaps = {};

    // Create a popup function that we'll add to each layer
    function popUp(feature, layer) {
        if (feature && feature.hasOwnProperty("properties") && feature.properties && feature.properties.hasOwnProperty("Location")) {
          var html = feature.properties.Location + "<br>" + feature.properties['Narrative (250, no formatting or links)'];
        } else {
          var html = "Location not found";
        }
        layer.bindPopup(html);
    }


    tasks.forEach(function(task) {
      task.geojson.features.forEach(function(feature){
        feature.properties = csvdata[task.csv_id-1]; // TODO: don't use index, use lookup
      });
    });

    function geojsonStyle(feature) {
      return {
        color: '#f09',
        opacity: 0.8,
        fillColor: '#f09',
        fillOpacity: 0.3,
        weight:2
      };
    }

    tasks.sort(function(a, b) { return d3.ascending(+a.csv_id, +b.csv_id);}).forEach(function(task) {
      task.layer = new L.GeoJSON(task.geojson, {style:geojsonStyle, onEachFeature:popUp});
      map.addLayer(task.layer);
      var label = task.geojson.features[0].properties.Location;
      if (!label) label = "no shape";
      overlayMaps[task.csv_id + ": " + label] = task.layer;
    });

    // Create our marker style for layers represented only as points
    var geojsonMarkerOptions = {
        radius: 8,
        fillColor: "steelblue",
        color: "steelblue",
        weight: 2,
        opacity: 0.8,
        fillOpacity: 0.3
    };

    // Create point map layers for any rows that have lat & lon
    csvdata.sort(function(a,b) { return d3.ascending(+a.ID, +b.ID);}).forEach(function(row) {
      if (row.Latitude && row.Longitude) {
        var layer = L.geoJson({
          "type": "Feature",
          "properties": row,
          "geometry": {
            "type": "Point",
            "coordinates": [row.Longitude, row.Latitude]
          }
        }, {
          pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, geojsonMarkerOptions);
          },
          onEachFeature: popUp
        });
        map.addLayer(layer);
        overlayMaps[row.ID + ": " + row.Location] = layer;
      }
    });

    var options = {
      collapsed: false
    };

    L.control.layers(null, overlayMaps, options).addTo(map);

  });
});

</script>
</body>
</html>
